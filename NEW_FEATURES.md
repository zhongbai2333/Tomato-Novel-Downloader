# 新功能说明 (New Features)

本次更新解决了用户反馈的几个重要问题，包括更新检测异常、书名不一致和文件覆盖问题。

## 1. 忽略书籍更新功能

### 问题背景
某些书籍由于番茄API返回数据不准确，会被持续检测为"有更新"，但实际章节内容与本地已下载文件完全一致。

### 解决方案
新增"忽略更新"功能，用户可以手动标记特定书籍忽略更新检查。

### 使用方法

#### TUI界面
1. 打开"更新检测"菜单（按 `u`）
2. 使用上下箭头选择要忽略的书籍
3. 按 `i` 键切换忽略状态
4. 被忽略的书籍会显示 `[已忽略]` 标记，并移至"无更新"列表

#### 存储位置
忽略状态保存在每本书各自的 `status.json` 文件中（位于书籍的临时文件夹内），而不是全局配置文件。这样设计的好处：
- 忽略状态与书籍绑定，更直观
- 删除书籍文件夹时，忽略状态也会一并删除
- 不会污染全局配置文件

### 特性
- 被忽略的书籍不会出现在"有更新"列表中
- 忽略状态持久化保存在书籍的 `status.json` 中
- 可随时通过按 `i` 键取消忽略
- 支持所有界面模式（TUI、Web UI、noui）

---

## 2. 书名一致性修复

### 问题背景
番茄小说API会返回多个不同的书名（book_name、book_short_name、original_book_name等），导致：
- 搜索列表中显示的书名是A
- 下载后的文件/文件夹名却是B
- 用户无法确定下载的是哪本书

### 解决方案
优化元数据合并逻辑，优先使用用户在搜索结果中看到的书名作为文件/文件夹命名。

### 改进效果
- **搜索时看到的书名** = **下载后的文件名**
- 提升用户体验，避免混淆
- 保持界面展示与实际存储的一致性

### 技术细节
新增 `merge_meta_prefer_hint_name()` 函数，在准备下载计划时：
- 书名（book_name）：优先使用搜索结果的名称
- 其他元数据（作者、简介等）：优先使用目录API的权威数据

---

## 3. 文件覆盖功能恢复

### 问题背景
v2.0.2 无法覆盖已存在的文件，而 v1.8.5 可以。这导致：
- 无法通过重新下载来修复错误命名的文件
- 功能退步，用户体验下降

### 解决方案
新增配置选项 `allow_overwrite_files`，默认允许覆盖（恢复v1.8.5行为）。

### 配置说明

在 `config.yml` 中：

```yaml
# 是否允许覆盖已存在的文件
allow_overwrite_files: true   # true = 允许覆盖（默认，恢复旧版本行为）
                               # false = 禁止覆盖（防止误操作）
```

### 行为说明

#### 当 `allow_overwrite_files: true`（默认）
- 重新下载同一本书时，会覆盖已存在的文件
- 与 v1.8.5 行为一致
- 适合需要更新/修复已下载文件的场景

#### 当 `allow_overwrite_files: false`
- 尝试下载已存在的文件时，会显示错误提示
- 避免误操作覆盖重要文件
- 适合谨慎使用的场景

### 使用建议
- 大多数用户保持默认值 `true` 即可
- 如果担心误操作，可以设为 `false`，需要覆盖时手动删除旧文件后再下载

---

## 4. 自定义书名基础支持

### 当前状态
已添加自定义书名的基础数据结构支持（`PendingDownload.custom_book_name`），为未来功能扩展做准备。

### 未来计划
后续版本可能会添加：
- 下载前弹出书名选择对话框，从API返回的多个名称中选择
- 支持用户自定义输入书名
- 保存用户的命名偏好

---

## 配置文件示例

新版本的 `config.yml` 会包含以下新增配置项：

```yaml
# ... 其他配置 ...

# 是否允许覆盖已存在的文件
allow_overwrite_files: true

# ... 其他配置 ...
```

**注意**: 忽略更新状态不再保存在 `config.yml` 中，而是保存在每本书各自的 `status.json` 文件里。

---

## 常见问题

### Q1: 如何找到书籍的ID？
A: 在更新检测列表或书籍详情中，书名后面括号内的数字就是书籍ID。例如：`《凋灵斯拉的平衡诸天之旅》(7439749573792255001)`，其中 `7439749573792255001` 就是书籍ID。

### Q2: 忽略的书籍还能下载吗？
A: 可以！忽略更新只是不在"有更新"列表中显示，不影响手动搜索和下载该书籍。

### Q3: 忽略状态保存在哪里？
A: 忽略状态保存在每本书的 `status.json` 文件中（位于 `<book_id>_<book_name>` 文件夹内），而不是全局配置文件。这样删除书籍文件夹时，忽略状态也会一并删除。

### Q4: 如何恢复文件覆盖功能？
A: 确保 `config.yml` 中 `allow_overwrite_files: true`（这是默认值）。如果之前手动改成了 `false`，改回 `true` 即可。

### Q5: 书名还是不一致怎么办？
A: 这通常发生在：
- 直接通过书籍ID下载（未经过搜索）
- 使用旧版本下载后用新版本更新

建议：删除旧文件，重新搜索并下载，新版本会使用一致的书名。

---

## 技术支持

如有问题或建议，请在 GitHub Issues 中反馈：
https://github.com/zhongbai2333/Tomato-Novel-Downloader/issues
