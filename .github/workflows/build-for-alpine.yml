name: Build for Alpine Linux

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest # 任务在Ubuntu宿主机上启动
    container:
      image: alpine:latest # 但在Alpine容器内执行所有步骤

    steps:
      # 关键修复：为容器内的checkout显式传递令牌
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # 此行必须存在

      - name: Install Alpine Build Dependencies
        run: |
          apk update
          apk add --no-cache \
            python3 \
            python3-dev \
            py3-pip \
            gcc \
            g++ \
            musl-dev \
            libffi-dev \
            openssl-dev \
            make \
            linux-headers

      - name: Install Python Dependencies
        run: |
          pip3 install --upgrade pip
          if [ -f requirements.txt ]; then
            pip3 install -r requirements.txt
          fi
          pip3 install pyinstaller

      - name: Build with PyInstaller
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="sha-${{ github.sha:0:8 }"
          fi
          
          python3 -m PyInstaller \
            --onefile \
            --name "MyApp-Alpine-$VERSION" \
            --clean \
            main.py # 请确保这是您的入口文件

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alpine-executable
          path: dist/MyApp-Alpine-* # 上传生成的可执行文件
