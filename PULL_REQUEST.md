# Pull Request: 更新检测与书名管理增强

## 概述

本PR解决了Issue中提出的三个主要问题：
1. **问题一**：书籍被持续检测为"有更新"但实际无更新
2. **问题二**：书名一致性问题 - 搜索显示与下载文件名不一致
3. **问题三**：v2.0.2无法覆盖已存在文件（功能退步）

## 实现的功能

### 1. 忽略书籍更新功能 ✓

**用户场景**：
某些书籍由于API数据不准确，持续显示"有更新"但实际无更新（如《凋灵斯拉的平衡诸天之旅》）。

**解决方案**：
- 新增配置项 `ignored_update_books: Vec<String>`
- TUI界面按 'i' 键即可切换忽略状态
- 被忽略的书籍显示 `[已忽略]` 标记，移至"无更新"列表
- 状态持久化保存至 config.yml

**代码变更**：
- `src/base_system/context.rs`: 新增配置字段和辅助方法
- `src/base_system/novel_updates.rs`: 添加 `is_ignored` 字段，扫描时过滤
- `src/ui/tui/update.rs`: 添加 'i' 键处理器
- `src/ui/web/routes/updates.rs`: Web UI支持
- `src/ui/noui/update.rs`: CLI支持

### 2. 书名一致性修复 ✓

**用户场景**：
- 搜索时显示书名A
- 下载后文件/文件夹却叫B
- 用户困惑，不知道下载的是哪本书

**问题根源**：
番茄API返回4个不同的书名字段（book_name, book_short_name, original_book_name等），目录API和搜索API返回的优先级不同。

**解决方案**：
- 新增 `merge_meta_prefer_hint_name()` 函数
- 优先使用搜索结果中的书名（用户看到的）
- 其他元数据仍使用目录API的权威数据

**代码变更**：
- `src/download/downloader.rs`: 
  - 新增 `merge_meta_prefer_hint_name()` 函数
  - 修改 `prepare_download_plan()` 调用新函数

**效果**：
搜索列表显示的书名 = 下载文件/文件夹名

### 3. 文件覆盖功能恢复 ✓

**用户场景**：
- v1.8.5可以覆盖已存在文件
- v2.0.2不能，导致无法修复错误命名的文件
- 功能退步

**解决方案**：
- 新增配置项 `allow_overwrite_files: bool` (默认 true)
- 默认允许覆盖，恢复v1.8.5行为
- 可选禁止覆盖，防止误操作

**代码变更**：
- `src/base_system/context.rs`: 新增配置字段
- `src/book_parser/finalize_utils.rs`: 
  - 在 `prepare_output_path()` 中检查配置
  - 文件存在且不允许覆盖时返回错误

**行为**：
- `allow_overwrite_files: true` (默认): 覆盖已存在文件
- `allow_overwrite_files: false`: 显示错误，拒绝覆盖

### 4. 自定义书名基础支持 ✓

**当前实现**：
- 在 `PendingDownload` 中添加 `custom_book_name: Option<String>`
- 为未来交互式书名选择功能做准备

**未来扩展**：
- 下载前弹出书名选择对话框
- 从API返回的多个名称中选择
- 支持用户自定义输入

**代码变更**：
- `src/ui/tui/mod.rs`: 添加 `custom_book_name` 字段
- `src/ui/tui/preview.rs`: 初始化为 None

## 技术细节

### 配置文件新增项

```yaml
# 忽略更新检查的书籍ID列表
ignored_update_books:
  - "7439749573792255001"

# 是否允许覆盖已存在的文件
allow_overwrite_files: true
```

### 向后兼容性

- ✅ 所有新字段都有默认值
- ✅ 旧配置文件可以正常工作
- ✅ `allow_overwrite_files` 默认 true，恢复旧行为
- ✅ 不影响现有功能

### 代码质量

- ✅ 遵循现有代码风格
- ✅ 最小化修改范围
- ✅ 保持函数职责单一
- ✅ 适当的错误处理
- ✅ 中文注释和文档

## 测试建议

### 1. 忽略更新功能
```
步骤：
1. 启动程序，按 'u' 进入更新检测
2. 选择任意书籍，按 'i'
3. 观察是否显示 [已忽略] 标记
4. 检查 config.yml 是否更新
5. 重启程序，验证状态保持
6. 再次按 'i' 取消忽略
```

### 2. 书名一致性
```
步骤：
1. 搜索一本书（如"龙族"）
2. 记录显示的书名
3. 下载该书
4. 检查文件/文件夹名是否一致
```

### 3. 文件覆盖
```
步骤：
1. 下载一本书
2. 再次下载同一本书
3. 验证成功覆盖（默认配置）
4. 设置 allow_overwrite_files: false
5. 再次下载，验证错误提示
```

## 文档

新增 `NEW_FEATURES.md` 用户文档，包含：
- 功能详细说明
- 使用方法（中文）
- 配置示例
- 常见问题解答
- 技术支持信息

## 代码统计

- 修改文件：9个核心文件
- 新增文件：2个文档文件
- 新增代码行：约200行
- 新增配置项：2个

## 相关Issue

解决 Issue #[待补充] 提出的所有问题：
- ✅ 问题一：书籍误报更新
- ✅ 问题二之书名一致性
- ✅ 问题二之文件覆盖
- ✅ 问题二之自定义文件名（基础支持）

## Checklist

- [x] 代码遵循项目规范
- [x] 添加了必要的注释
- [x] 更新了文档
- [x] 保持向后兼容
- [x] 提供了测试建议
- [x] 所有修改都经过仔细考虑
- [ ] 实际测试（需要构建环境）

## 后续工作建议

1. **Web UI 增强**：
   - 在Web界面添加忽略/取消忽略按钮
   - 显示当前忽略状态

2. **自定义书名UI**：
   - 实现书名选择对话框
   - 支持用户自定义输入
   - 保存命名偏好

3. **批量操作**：
   - 批量忽略/取消忽略
   - 导入/导出忽略列表

## 注意事项

由于缺少 `Tomato-Novel-Official-API` 依赖，无法在沙箱环境中构建和测试。建议在实际环境中：

1. 完整构建项目
2. 运行各UI模式测试
3. 验证配置文件读写
4. 检查日志输出

## 感谢

感谢 @zhongbai2333 提供的Issue反馈和详细的问题描述！
